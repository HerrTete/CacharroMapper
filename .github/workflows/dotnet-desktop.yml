# This workflow will build and test the .NET solution
# For more information on GitHub Actions, refer to https://github.com/features/actions

name: Build and Test

on:
  push:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:

  build:

    strategy:
      matrix:
        configuration: [Debug, Release]

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Restore dependencies
    - name: Restore dependencies
      run: dotnet restore src/EasyMapper.sln

    # Build the solution
    - name: Build
      run: dotnet build src/EasyMapper.sln --configuration ${{ matrix.configuration }} --no-restore

    # Execute all unit tests in the solution
    - name: Test
      run: dotnet test src/EasyMapper.sln --configuration ${{ matrix.configuration }} --no-build --verbosity normal

    # Pack the NuGet package (Release only)
    - name: Pack NuGet package
      if: matrix.configuration == 'Release' && github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: dotnet pack src/EasyMapper/EasyMapper.csproj --configuration Release --no-build --output nupkg

    # Publish to GitHub Packages (Release only, main branch)
    - name: Publish NuGet package to GitHub Packages
      if: matrix.configuration == 'Release' && github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        Get-ChildItem -Recurse -Filter EasyMapper.*.nupkg | ForEach-Object {
          dotnet nuget push $_.FullName --source "https://nuget.pkg.github.com/HerrTete/index.json" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
        }
